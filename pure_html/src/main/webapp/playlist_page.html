<!-- TODO: da rivedere e provare con dati effettivi -->

<!DOCTYPE html>
<html lang="it" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Playlist • Playlist Manager</title>
    <link rel="stylesheet" href="css/app.css" th:href="@{/css/app.css}" />
    <link rel="icon" sizes="32x32" type="image/png" href="img/icon.png" th:href="@{/img/icon.png}">
</head>
<body class="page-has-top-center">
<!-- Home -->
<a class="iconbtn corner corner-center"
   href="HomePage.html" th:href="@{/HomePage}" aria-label="Vai alla Home">
    <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
        <path d="M12 3l9 8h-3v10H6V11H3z"/>
    </svg>
</a>

<div class="wrap wide playlist-page">
    <h1 class="title" th:text="${playlistTitle}">La mia Playlist</h1>

    <div id="playlistBrowser" class="playlist-browser">
        <div class="playlist-nav-row">
            <a class="btn ghost playlist-nav-btn" th:if="${hasPrev}" th:href="@{/Playlist(playlistId=${playlistId},gr=${trackGroup - 1})}">PRECEDENTI</a>
            <div class="playlist-row" role="grid" aria-label="Brani della playlist (blocco da 5)">
                <div th:if="${#lists.isEmpty(playlistTracks)}" class="muted-msg" style="flex:1;display:flex;align-items:center;justify-content:center;">Nessun brano in questa playlist.</div>
                <a class="playlist-cell" th:each="t : ${playlistTracks}" th:href="@{/player(trackId=${t.id})}" th:title="${t.title}">
                    <div class="pl-cover">
                        <img th:if="${t.image_path != null}" th:src="@{/${t.image_path}}" th:alt="${'Copertina ' + t.album_title}" />
                        <div class="pl-cover-placeholder" th:if="${t.image_path == null}" aria-hidden="true">♪</div>
                    </div>
                    <div class="pl-meta">
                        <div class="pl-song-title" th:text="${t.title}">Titolo</div>
                        <div class="pl-artist" th:text="${t.artist}">Artista</div>
                        <div class="pl-album" th:text="${t.album_title + (t.year != null ? ' · ' + t.year : '')}">Album · 2024</div>
                    </div>
                </a>
            </div>
            <a class="btn ghost playlist-nav-btn" th:if="${hasNext}" th:href="@{/Playlist(playlistId=${playlistId},gr=${trackGroup + 1})}">SUCCESSIVI</a>
        </div>
        <p id="emptyPlaylistMsg" class="muted-msg" th:if="${#lists.isEmpty(playlistTracks) && !hasPrev && !hasNext}" >La playlist è vuota. Aggiungi qualche brano.</p>
    </div>

    <div class="actions-row top-actions" style="margin-top:28px;">
        <button type="button" class="btn" th:if="${addableTracks != null && !#lists.isEmpty(addableTracks)}" onclick="openAddTracksModal()">Aggiungi brani</button>
        <button type="button" class="btn secondary" th:if="${addableTracks == null || #lists.isEmpty(addableTracks)}" disabled>Nessun brano disponibile</button>
    </div>
</div>

<!-- MODAL Aggiunta Brani -->
<div id="addTracksModal" class="modal-overlay">
    <div class="modal">
        <div class="modal-header">
            <h2 class="modal-title">Aggiungi Brani alla Playlist</h2>
            <button class="modal-close" type="button" aria-label="Chiudi" onclick="closeAddTracksModal()">
                <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
            </button>
        </div>
        <div class="modal-content">
            <form id="addTracksForm" method="post" th:action="@{/AddTracks}">
                <input type="hidden" name="playlistId" th:value="${playlistId}" />
                <div class="form-group">
                    <label class="form-label">Seleziona brani (non presenti nella playlist)</label>
                    <div class="playlist-tracks-block" id="addTracksBlock">
                        <div class="playlist-tracks-tools" th:if="${addableTracks != null && !#lists.isEmpty(addableTracks)}">
                            <div class="field" style="flex:1; height:42px;">
                                <input type="search" id="addTrackFilter" placeholder="Filtra brani (titolo, artista, album)..." autocomplete="off" />
                            </div>
                            <div class="counts">
                                <span id="selectedAddCount">0</span>/<span th:text="${#lists.size(addableTracks)}">0</span> selezionati
                            </div>
                        </div>
                        <ul class="playlist-tracks-list" id="addTracksList">
                            <li class="playlist-tracks-empty" th:if="${addableTracks == null || #lists.isEmpty(addableTracks)}">Nessun brano disponibile</li>
                            <li class="track-choice" th:each="t : ${addableTracks}">
                                <input type="checkbox" th:id="'pladd_' + ${t.id}" th:value="${t.id}" name="selectedTracksIds" />
                                <label th:for="'pladd_' + ${t.id}" class="track-choice-info">
                                    <span class="track-choice-title" th:text="${t.title}">Titolo</span>
                                    <span class="track-choice-meta">
                                        <span th:text="${t.artist}">Artista</span>
                                        <span> · </span>
                                        <span th:text="${t.album_title}">Album</span>
                                        <span th:if="${t.year != null}"> · <span th:text="${t.year}">2024</span></span>
                                    </span>
                                </label>
                            </li>
                        </ul>
                        <div class="playlist-tracks-actions" th:if="${addableTracks != null && !#lists.isEmpty(addableTracks)}">
                            <button type="button" id="selectAllAddTracksBtn" title="Seleziona tutti i brani visibili">Seleziona tutti</button>
                            <button type="button" id="clearAddTracksBtn" title="Deseleziona tutti i brani">Pulisci</button>
                        </div>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn ghost" onclick="closeAddTracksModal()">Annulla</button>
                    <button type="submit" class="btn" id="confirmAddTracksBtn" disabled>Aggiungi alla playlist</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- RIMOSSA logica JS di paginazione client: ora server-side -->
<script>
(function(){
    const overlay = document.getElementById('addTracksModal');
    const listEl = document.getElementById('addTracksList');
    const filterInput = document.getElementById('addTrackFilter');
    const selectAllBtn = document.getElementById('selectAllAddTracksBtn');
    const clearBtn = document.getElementById('clearAddTracksBtn');
    const countEl = document.getElementById('selectedAddCount');
    const confirmBtn = document.getElementById('confirmAddTracksBtn');

    function openAddTracksModal(){ if(!overlay) return; overlay.classList.add('active'); overlay.style.display='flex'; document.body.style.overflow='hidden'; setTimeout(()=>filterInput?.focus(),80); }
    function closeAddTracksModal(){ if(!overlay) return; overlay.classList.remove('active'); overlay.style.display='none'; document.body.style.overflow=''; resetModalState(); }
    window.openAddTracksModal = openAddTracksModal; window.closeAddTracksModal = closeAddTracksModal;

    function updateHighlight(chk){ const li=chk.closest('li.track-choice'); if(li) li.classList.toggle('track-choice--selected', chk.checked); }
    function updateCount(){ const sel=listEl?listEl.querySelectorAll('input[type="checkbox"]:checked').length:0; if(countEl) countEl.textContent=sel; if(confirmBtn) confirmBtn.disabled = sel===0; }

    function applyFilter(){ if(!filterInput||!listEl) return; const term=filterInput.value.trim().toLowerCase(); let visible=0; listEl.querySelectorAll('li.track-choice').forEach(li=>{ const txt=(li.textContent||'').toLowerCase(); const show=!term||txt.includes(term); li.style.display=show?'':'none'; if(show) visible++; }); if(selectAllBtn) selectAllBtn.disabled = (visible===0); }
    function selectAllVisible(){ if(!listEl) return; listEl.querySelectorAll('li.track-choice').forEach(li=>{ if(li.style.display==='none') return; const chk=li.querySelector('input[type="checkbox"]'); if(chk && !chk.checked){ chk.checked=true; updateHighlight(chk);} }); updateCount(); }
    function clearAll(){ if(!listEl) return; listEl.querySelectorAll('input[type="checkbox"]').forEach(ch=>{ if(ch.checked){ ch.checked=false; updateHighlight(ch);} }); updateCount(); }
    function resetModalState(){ clearAll(); if(filterInput){ filterInput.value=''; applyFilter(); } }

    function init(){ if(!overlay) return; overlay.addEventListener('click',e=>{ if(e.target===overlay) closeAddTracksModal(); }); document.addEventListener('keydown',e=>{ if(e.key==='Escape' && overlay.classList.contains('active')) closeAddTracksModal(); }); listEl?.addEventListener('change',e=>{ const t=e.target; if(t && t.matches('input[type="checkbox"]')){ updateHighlight(t); updateCount(); }}); filterInput?.addEventListener('input',applyFilter); selectAllBtn?.addEventListener('click',selectAllVisible); clearBtn?.addEventListener('click',clearAll); updateCount(); }
    document.addEventListener('DOMContentLoaded', init);
})();
</script>
</body>
</html>
