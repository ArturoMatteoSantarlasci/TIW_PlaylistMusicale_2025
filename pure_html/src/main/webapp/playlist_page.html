<!DOCTYPE html>
<html lang="it" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title th:text="${playlistTitle} + ' • Playlist'">Playlist</title>
  <link rel="stylesheet" href="css/app.css" th:href="@{/css/app.css}" />
  <link rel="icon" sizes="32x32" type="image/png" href="img/icon2.png" th:href="@{/img/icon2.png}">
  <style>
    .modal-overlay { display: none; }
    .modal-overlay:target { display: flex; position: fixed; inset: 0; }
    body:has(.modal-overlay:target) { overflow: hidden; }
    /* Garantisce che le card link siano cliccabili a tutta larghezza */
    a.track-card { display: flex; text-decoration: none; color: inherit; }
  </style>
</head>
<body class="page-home">
  <header class="header">
    <div class="header-left"></div>
    <h1 class="header-title main-label sr-only" id="plpage" th:text="${playlistTitle}">Playlist</h1>
    <div class="header-right actions-row" style="gap:14px;">
      <a class="iconbtn" aria-label="Homepage" href="HomePage" th:href="@{/HomePage}">
          <svg viewBox="0 0 24 24" width="29" height="29"
               fill="none" stroke="currentColor" stroke-width="2"
               stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <!-- contorno casa -->
              <path d="M3 11l9-7 9 7"/>
              <path d="M5 10v9a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-9"/>
              <!-- porta piena -->
              <rect x="10" y="14" width="4" height="7" rx="1" ry="1"
                    fill="currentColor" stroke="none"/>
          </svg>
      </a>
      <a class="btn secondary" href="#addTracksModal">Aggiungi Brani</a>
      <a class="btn secondary logout"
         style="font-size:1.17rem !important; font-weight:800 !important; height:50px !important; padding:0 16px !important; display:flex !important; align-items:center !important; justify-content:center !important;"
         href="Logout" th:href="@{/Logout}">Logout</a>
    </div>
  </header>

  <main class="main">
    <div class="tracks-wrapper">
      <!-- Toast server-side (success aggiunta brani) -->
      <div class="toast" role="status" aria-live="polite" aria-atomic="true" th:if="${addedCount != null}">
        <span th:text="${addedCount == 1 ? '1 brano aggiunto' : addedCount + ' brani aggiunti'}">1 brano aggiunto</span>
      </div>

      <div th:if="${#lists.isEmpty(playlistTracks)}" style="color:var(--am-muted);text-align:center;padding:30px 0;">Nessun brano in questa playlist.</div>
      <div class="tracks-vertical" th:if="${!#lists.isEmpty(playlistTracks)}" id="playlistTracks">
        <a class="track-card" th:each="t,iter : ${playlistTracks}"
           th:href="@{/player(trackId=${t.trackId}, playlistId=${playlistId}, gr=${trackGroup})}">
          <div class="track-cover">
            <img th:if="${t.imageUrl != null and !#strings.isEmpty(t.imageUrl)}" th:src="${t.imageUrl}" th:alt="${'Copertina di ' + t.title}" alt="Copertina" />
            <img th:if="${t.imageUrl == null or #strings.isEmpty(t.imageUrl)}" th:src="@{/img/placeholder_cover.svg}" alt="Placeholder" class="track-cover--placeholder" />
          </div>
          <div class="track-info">
            <div class="track-title" th:text="${t.title}">Titolo</div>
            <div class="track-sub">
              <span th:text="${t.artist}">Artista</span>
            </div>
            <div class="track-sub" style="font-size:.7rem;" th:if="${t.albumLine != null}" th:text="${t.albumLine}">Album·Anno·Genere</div>
          </div>
        </a>
      </div>

      <!-- Paginazione gruppi -->
      <div class="pagination-row" th:if="${totalGroups > 0}" style="display:flex;align-items:center;justify-content:space-between;gap:24px;margin-top:32px;">
        <a id="prevBtn" class="btn secondary" th:if="${trackGroup > 0}" th:href="@{/Playlist(playlistId=${playlistId}, gr=${trackGroup - 1})}">Precedenti</a>
        <div class="pagination-label" style="font-size:.85rem;font-weight:600;color:var(--am-accent);flex:1;text-align:center;letter-spacing:.3px;">
          Pagina <span id="pageIndex" th:text="${trackGroup + 1}">1</span> / <span id="pageTotal" th:text="${totalGroups}">1</span>
        </div>
        <a id="nextBtn" class="btn secondary" th:if="${trackGroup + 1 < totalGroups}" th:href="@{/Playlist(playlistId=${playlistId}, gr=${trackGroup + 1})}">Successivi</a>
      </div>
    </div>
  </main>

  <!-- Modal Aggiungi brani -->
  <div id="addTracksModal" class="modal-overlay">
    <div class="modal" style="max-width:640px;width:100%;">
      <div class="modal-header">
        <h2 class="modal-title">Aggiungi brani</h2>
        <a class="modal-close" href="#plpage" aria-label="Chiudi">
          <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </a>
      </div>
      <div class="modal-content">
        <form th:action="@{/AddTracks}" method="post" id="addTracksForm">
          <input type="hidden" name="playlistId" th:value="${playlistId}" />

          <div class="form-group" th:if="${#lists.isEmpty(addableTracks)}">
            <div style="padding:12px 4px;font-size:.85rem;color:var(--am-muted);">Non ci sono altri brani disponibili da aggiungere.</div>
          </div>

          <div th:if="${!#lists.isEmpty(addableTracks)}">
            <div class="playlist-tracks-block" id="addableTracksBlock">
              <div style="max-height:50vh; overflow:auto;">
                <ul class="playlist-tracks-list" id="addTracksList">
                  <li class="track-choice" th:each="t : ${addableTracks}">
                    <input type="checkbox" th:id="'addtrk_' + ${t.id}" th:value="${t.id}" name="selectedTracks" />
                    <label th:for="'addtrk_' + ${t.id}" class="track-choice-info">
                      <span class="track-choice-title" th:text="${t.title}">Titolo</span>
                      <span class="track-choice-meta">
                        <span th:text="${t.artist}">Artista</span>
                        <span> · </span>
                        <span th:text="${t.album_title}">Album</span>
                        <span th:if="${t.year != null}"> · <span th:text="${t.year}">2024</span></span>
                      </span>
                    </label>
                  </li>
                </ul>
              </div>
            </div>
          </div>

          <div class="modal-actions" style="margin-top:16px;">
            <a href="#plpage" class="btn ghost">Annulla</a>
            <button type="submit" class="btn" th:disabled="${#lists.isEmpty(addableTracks)}">Aggiungi</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</body>
</html>
