
<!DOCTYPE html>
<html lang="it" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title th:text="${playlistTitle} + ' • Playlist'">Playlist</title>
  <link rel="stylesheet" href="css/app.css" th:href="@{/css/app.css}" />
  <link rel="icon" sizes="32x32" type="image/png" href="img/icon2.png" th:href="@{/img/icon2.png}">
</head>
<body class="page-home">
  <header class="header">
    <div class="header-left"></div>
    <h1 class="header-title main-label sr-only" th:text="${playlistTitle}">Playlist</h1>
    <div class="header-right actions-row" style="gap:14px;">
  <button type="button" class="iconbtn" aria-label="Homepage" onclick="window.location.href=this.getAttribute('data-href')" th:attr="data-href=@{/HomePage}">
          <svg viewBox="0 0 24 24" width="29" height="29"
               fill="none" stroke="currentColor" stroke-width="2"
               stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <!-- contorno casa -->
              <path d="M3 11l9-7 9 7"/>
              <path d="M5 10v9a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-9"/>
              <!-- porta piena -->
              <rect x="10" y="14" width="4" height="7" rx="1" ry="1"
                    fill="currentColor" stroke="none"/>
          </svg>      </button>
      <button type="button" class="btn secondary" onclick="openAddTracksModal()">Aggiungi Brani</button>
      <a class="btn secondary logout"
         style="font-size:1.17rem !important; font-weight:800 !important; height:50px !important; padding:0 16px !important; display:flex !important; align-items:center !important; justify-content:center !important;"

         href="Logout" th:href="@{/Logout}">Logout</a>
    </div>
  </header>

  <main class="main">
    <div class="tracks-wrapper">
      <!-- Toast placeholder (success aggiunta brani) -->
      <div id="flashToast" class="toast" role="status" aria-live="polite" aria-atomic="true" th:if="${addedCount != null}" th:data-addedcount="${addedCount}" style="display:none"></div>

      <div th:if="${#lists.isEmpty(playlistTracks)}" style="color:var(--am-muted);text-align:center;padding:30px 0;">Nessun brano in questa playlist.</div>
      <div class="tracks-vertical" th:if="${!#lists.isEmpty(playlistTracks)}" id="playlistTracks">
     <div class="track-card js-open-player"
             th:each="t,iter : ${playlistTracks}"
             th:data-id="${t.trackId}"
             th:data-title="${t.title}"
             th:data-artist="${t.artist}"
             th:data-album="${t.album_title}"
       th:data-audio="${t.audioUrl}"
       th:data-player-url="@{/player(trackId=${t.trackId})}"
       th:data-image="${t.imageUrl}"
       data-id="1" data-title="Titolo" data-artist="Artista" data-album="Album" data-image="">
          <div class="track-cover">
            <img th:if="${t.imageUrl != null and !#strings.isEmpty(t.imageUrl)}" th:src="${t.imageUrl}" th:alt="${'Copertina di ' + t.title}" alt="Copertina" />
            <img th:if="${t.imageUrl == null or #strings.isEmpty(t.imageUrl)}" th:src="@{/img/placeholder_cover.svg}" alt="Placeholder" class="track-cover--placeholder" />
          </div>
          <div class="track-info">
            <div class="track-title" th:text="${t.title}">Titolo</div>
            <div class="track-sub">
              <span th:text="${t.artist}">Artista</span>
            </div>
            <div class="track-sub" style="font-size:.7rem;" th:if="${t.albumLine != null}" th:text="${t.albumLine}">Album·Anno·Genere</div>
          </div>
        </div>
      </div>

      <!-- Paginazione gruppi -->
    <div class="pagination-row" th:if="${totalGroups > 0}" style="display:flex;align-items:center;justify-content:space-between;gap:24px;margin-top:32px;">
      <a id="prevBtn" class="btn secondary" th:if="${trackGroup > 0}" th:href="@{/Playlist(playlistId=${playlistId}, gr=${trackGroup - 1})}">Precedenti</a>
      <div class="pagination-label" style="font-size:.85rem;font-weight:600;color:var(--am-accent);flex:1;text-align:center;letter-spacing:.3px;">
        Pagina <span id="pageIndex" th:text="${trackGroup + 1}">1</span> / <span id="pageTotal" th:text="${totalGroups}">1</span>
      </div>
      <a id="nextBtn" class="btn secondary" th:if="${trackGroup + 1 < totalGroups}" th:href="@{/Playlist(playlistId=${playlistId}, gr=${trackGroup + 1})}">Successivi</a>
    </div>
    <div id="toast" class="toast" role="status" aria-live="polite" aria-atomic="true"></div>
    </div>
  </main>
  <!-- Mini player bottom -->
  <div id="miniPlayer" class="mini-player hidden" aria-hidden="true">
    <button type="button" class="mini-btn mini-close" id="miniClose" aria-label="Chiudi mini player" title="Chiudi">
      <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
    </button>
    <button type="button" class="mini-btn prev" id="miniPrev" aria-label="Precedente" disabled>
      <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M10 12L18 6v12l-8-6zm-4 6V6h2v12H6z"/></svg>
    </button>
    <button type="button" class="mini-btn play" id="miniPlay" aria-label="Riproduci">
      <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
    </button>
    <button type="button" class="mini-btn next" id="miniNext" aria-label="Successiva" disabled>
      <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M14 12L6 6v12l8-6zm4 6V6h-2v12h2z"/></svg>
    </button>
    <div class="mini-meta" id="miniMeta"><span class="t" id="miniTitle">—</span><span class="s" id="miniArtist">—</span></div>
    <audio id="miniAudio" preload="metadata"></audio>
  </div>
  <!-- Modal Aggiungi brani -->
  <div id="addTracksModal" class="modal-overlay">
    <div class="modal" style="max-width:640px;width:100%;">
      <div class="modal-header">
  <h2 class="modal-title">Aggiungi brani</h2>
        <button class="modal-close" type="button" onclick="closeAddTracksModal()" aria-label="Chiudi">
          <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </div>
      <div class="modal-content">
        <form th:action="@{/AddTracks}" method="post" id="addTracksForm">
          <input type="hidden" name="playlistId" th:value="${playlistId}" />
          <div class="form-group" th:if="${#lists.isEmpty(addableTracks)}">
            <div style="padding:12px 4px;font-size:.85rem;color:var(--am-muted);">Non ci sono altri brani disponibili da aggiungere.</div>
          </div>
          <div th:if="${!#lists.isEmpty(addableTracks)}">
            <div class="playlist-tracks-block" id="addableTracksBlock">
              <div class="playlist-tracks-tools" style="margin-bottom:6px;">
                <div class="field" style="flex:1;height:42px;">
                  <input type="search" id="addTrackFilter" placeholder="Filtra brani..." autocomplete="off" />
                </div>
                <div class="counts"><span id="addSelectedCount">0</span>/<span th:text="${#lists.size(addableTracks)}">0</span> selezionati</div>
              </div>
              <div class="custom-scroll-wrapper">
              <ul class="playlist-tracks-list custom-scroll-hide-native" id="addTracksList">
                <li class="track-choice" th:each="t : ${addableTracks}" th:data-search="${(t.title + ' ' + t.artist + ' ' + t.album_title).toLowerCase()}">
                  <input type="checkbox" th:id="'addtrk_' + ${t.id}" th:value="${t.id}" name="selectedTracksIds" />
                  <label th:for="'addtrk_' + ${t.id}" class="track-choice-info">
                    <span class="track-choice-title" th:text="${t.title}">Titolo</span>
                    <span class="track-choice-meta">
                      <span th:text="${t.artist}">Artista</span>
                      <span> · </span>
                      <span th:text="${t.album_title}">Album</span>
                      <span th:if="${t.year != null}"> · <span th:text="${t.year}">2024</span></span>
                    </span>
                  </label>
                </li>
              </ul>
              <div class="custom-scrollbar"><div class="custom-scrollbar-track"><span class="custom-scrollbar-thumb"></span></div></div>
              </div>
              <div class="playlist-tracks-actions" style="margin-top:6px;display:flex;gap:8px;" th:if="${!#lists.isEmpty(addableTracks)}">
                <button type="button" id="addSelectAllBtn">Seleziona tutti</button>
                <button type="button" id="addClearBtn">Pulisci</button>
              </div>
            </div>
          </div>
          <div class="modal-actions" style="margin-top:16px;">
            <button type="button" class="btn ghost" onclick="closeAddTracksModal()">Annulla</button>
            <button type="submit" class="btn" th:disabled="${#lists.isEmpty(addableTracks)}">Aggiungi</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <script>
    // Click singolo rimane navigazione alla pagina player, doppio click apre mini player inline
    (function(){
      const listRoot = document.getElementById('playlistTracks');
      if(!listRoot) return;
      let clickTimer = null;
      listRoot.addEventListener('click', e => {
        const card = e.target.closest('.track-card');
        if(!card) return;
        if(clickTimer){
          clearTimeout(clickTimer); clickTimer = null;
          openMiniFromCard(card);
        } else {
          clickTimer = setTimeout(()=>{
            const url = card.getAttribute('data-player-url');
            if(url) window.location.href = url;
            clickTimer = null;
          },250); // finestra double-click
        }
      });
    })();

    // Flash toast per addedCount (success aggiunta brani) convertito da blocco persistente
    (function(){
      const t = document.getElementById('flashToast');
      if(!t) return;
      const added = parseInt(t.getAttribute('data-addedcount'),10);
      let msg;
      if(isNaN(added)) return;
      msg = added > 0 ? (added + (added === 1 ? ' brano aggiunto' : ' brani aggiunti')) : 'Nessun nuovo brano';
      t.textContent = msg;
      t.style.display='block';
      t.classList.add('show');
      setTimeout(()=>{ t.classList.remove('show'); setTimeout(()=> t.remove(), 400); }, 2600);
    })();

    function openMiniFromCard(card){
      const audioEl = document.getElementById('miniAudio');
      const mp = document.getElementById('miniPlayer');
      if(!audioEl || !mp) return;
      // Raccogli tutte le card per prev/next
      const cards = Array.from(document.querySelectorAll('#playlistTracks .track-card'));
      const idx = cards.indexOf(card);
      const src = card.getAttribute('data-audio');
      const title = card.getAttribute('data-title')||'';
      const artist = card.getAttribute('data-artist')||'';
      if(src){
        audioEl.src = src;
        audioEl.play().catch(()=>{});
      }
      document.getElementById('miniTitle').textContent = title;
      document.getElementById('miniArtist').textContent = artist;
      mp.classList.remove('hidden');
      mp.setAttribute('aria-hidden','false');
      mp.dataset.index = idx.toString();
      document.body.classList.add('has-mini-player');
      updatePrevNext(idx, cards.length);
      setPlayIcon(true);
    }

    function updatePrevNext(i,total){
      const prev = document.getElementById('miniPrev');
      const next = document.getElementById('miniNext');
      prev.disabled = i<=0; next.disabled = i>=total-1;
    }
    function setPlayIcon(isPlaying){
      const btn = document.getElementById('miniPlay');
      if(!btn) return;
      btn.innerHTML = isPlaying
        ? '<svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M8 5h4v14H8zm6 0h4v14h-4z"/></svg>'
        : '<svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>';
      btn.setAttribute('aria-label', isPlaying? 'Pausa' : 'Riproduci');
    }
    (function miniLogic(){
      const audio = document.getElementById('miniAudio');
      const play = document.getElementById('miniPlay');
      const prev = document.getElementById('miniPrev');
      const next = document.getElementById('miniNext');
      const mp = document.getElementById('miniPlayer');
      if(!audio || !play) return;
      play.addEventListener('click', ()=>{ if(audio.paused){ audio.play(); } else { audio.pause(); } });
      audio.addEventListener('play', ()=> setPlayIcon(true));
      audio.addEventListener('pause', ()=> setPlayIcon(false));
      function move(dir){
        const cards = Array.from(document.querySelectorAll('#playlistTracks .track-card'));
        if(!mp.dataset.index) return; let i = parseInt(mp.dataset.index,10);
        const ni = i + dir; if(ni <0 || ni>=cards.length) return;
        openMiniFromCard(cards[ni]);
      }
      prev?.addEventListener('click',()=> move(-1));
      next?.addEventListener('click',()=> move(1));
      audio.addEventListener('ended', ()=> move(1));
    })();
    // Paginazione: bottoni nascosti ai limiti già gestiti server-side via th:if
  // Gestione modal aggiungi tracce
    (function(){
      const overlay = document.getElementById('addTracksModal');
      if(!overlay) return;
      const list = document.getElementById('addTracksList');
      const filter = document.getElementById('addTrackFilter');
      const countSpan = document.getElementById('addSelectedCount');
      const selectAllBtn = document.getElementById('addSelectAllBtn');
      const clearBtn = document.getElementById('addClearBtn');
      function updateCount(){
        const sel = list? list.querySelectorAll('input[type="checkbox"]:checked').length : 0;
        if(countSpan) countSpan.textContent = sel;
      }
      function open(){ overlay.classList.add('active'); overlay.style.display='flex'; document.body.style.overflow='hidden'; filter && setTimeout(()=>filter.focus(),80);} 
      function close(){ overlay.classList.remove('active'); overlay.style.display='none'; document.body.style.overflow=''; }
      window.openAddTracksModal = open;
      window.closeAddTracksModal = close;
      overlay.addEventListener('click', e=>{ if(e.target===overlay) close(); });
      filter?.addEventListener('input',()=>{
        const q = filter.value.trim().toLowerCase();
        if(!list) return;
        list.querySelectorAll('.track-choice').forEach(li=>{
          const s = li.getAttribute('data-search')||'';
            li.style.display = s.includes(q)? '' : 'none';
        });
      });
      list?.addEventListener('change',updateCount);
      selectAllBtn?.addEventListener('click',()=>{ list?.querySelectorAll('input[type="checkbox"]').forEach(cb=>{ if(cb.offsetParent!==null) cb.checked=true;}); updateCount(); });
      clearBtn?.addEventListener('click',()=>{ list?.querySelectorAll('input[type="checkbox"]').forEach(cb=> cb.checked=false); updateCount(); });
    })();
  // Mini player close support (pure_html variant)
  (function(){
    const mp = document.getElementById('miniPlayer');
    const closeBtn = document.getElementById('miniClose');
    const audio = document.getElementById('miniAudio');
    if(closeBtn && mp){
      closeBtn.addEventListener('click', ()=>{
        try{ audio?.pause(); }catch(e){}
        if(audio){ audio.removeAttribute('src'); }
        mp.classList.add('hidden'); mp.setAttribute('aria-hidden','true'); mp.removeAttribute('data-index');
        document.body.classList.remove('has-mini-player');
      });
    }
  })();
  </script>
  <script>
  // Scrollbar custom 5cm per addTracksList (sempre visibile anche con pochi elementi)
  (function(){
    const wrapper = document.querySelector('#addTracksList')?.closest('.custom-scroll-wrapper');
    if(!wrapper) return;
    const list = wrapper.querySelector('.playlist-tracks-list');
    const thumb = wrapper.querySelector('.custom-scrollbar-thumb');
    const track = wrapper.querySelector('.custom-scrollbar-track');
    if(!list||!thumb||!track) return;
    function enforce(){
      if(list.scrollHeight <= list.clientHeight){ thumb.style.top='0px'; return; }
      const maxScroll = list.scrollHeight - list.clientHeight;
      const trackH = track.clientHeight;
      const maxTop = trackH - thumb.offsetHeight;
      const ratio = list.scrollTop / maxScroll;
      thumb.style.top = (ratio * maxTop) + 'px';
    }
    list.addEventListener('scroll', enforce);
    window.addEventListener('resize', enforce);
    let dragging=false, startY=0, startTop=0;
    thumb.addEventListener('mousedown', e=>{ dragging=true; startY=e.clientY; startTop=parseFloat(thumb.style.top)||0; wrapper.classList.add('dragging'); e.preventDefault(); });
    document.addEventListener('mousemove', e=>{ if(!dragging) return; const dy=e.clientY-startY; const trackH=track.clientHeight; const maxTop=trackH-thumb.offsetHeight; let newTop=Math.min(Math.max(0,startTop+dy),maxTop); thumb.style.top=newTop+'px'; const maxScroll=list.scrollHeight-list.clientHeight; if(maxScroll>0){ list.scrollTop = (newTop/maxTop)*maxScroll; } });
    document.addEventListener('mouseup', ()=>{ if(dragging){ dragging=false; wrapper.classList.remove('dragging'); }});
    track.addEventListener('wheel', e=>{ e.preventDefault(); list.scrollTop += e.deltaY; }, {passive:false});
    const mo = new MutationObserver(()=>{ requestAnimationFrame(enforce); });
    mo.observe(list,{childList:true,subtree:true});
    enforce();
  })();
  </script>
</body>
</html>
