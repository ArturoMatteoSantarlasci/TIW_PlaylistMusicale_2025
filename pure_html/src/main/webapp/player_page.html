<!DOCTYPE html>
<html lang="it" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>Player • Playlist Manager</title>
    <link rel="stylesheet" href="css/app.css" th:href="@{/css/app.css}" />
    <link rel="icon" sizes="32x32" type="image/png" href="img/icon2.png" th:href="@{/img/icon2.png}">
</head>
<body class="page-player">
<header class="header">
    <div class="header-left"></div>
    <div class="header-right actions-row" style="gap:14px;">
    <button type="button" class="iconbtn" aria-label="Homepage" onclick="window.location.href=this.getAttribute('data-href')" th:attr="data-href=@{/HomePage}">
            <svg viewBox="0 0 24 24" width="29" height="29"
                 fill="none" stroke="currentColor" stroke-width="2"
                 stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <!-- contorno casa -->
                <path d="M3 11l9-7 9 7"/>
                <path d="M5 10v9a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-9"/>
                <!-- porta piena -->
                <rect x="10" y="14" width="4" height="7" rx="1" ry="1"
                      fill="currentColor" stroke="none"/>
            </svg>        </button>
        <a class="btn secondary logout"
           style="font-size:1.17rem !important; font-weight:800 !important; height:50px !important; padding:0 16px !important; display:flex !important; align-items:center !important; justify-content:center !important;"

           th:href="@{/Logout}" href="Logout">Logout</a>
        <!-- Back to playlist (only player page) -->
        <button type="button" id="backToPlaylistBtn" class="iconbtn" title="Torna alla playlist" aria-label="Torna alla playlist">
            <svg viewBox="0 0 24 24" width="29" height="29" fill="currentColor" aria-hidden="true">
                <path d="M10 9V5L3 12l7 7v-4.1c5.1 0 8.6 1.8 11 5.1
             c-1-5.7-4.6-10.9-11-11.0H10z"/>
            </svg>        </button>
    </div>
</header>

<div class="player-track-info">
    <div class="player-cover">
        <img th:if="${track.coverUrl != null and !#strings.isEmpty(track.coverUrl)}" th:src="${track.coverUrl}" th:alt="${'Copertina di ' + track.title}" alt="Cover" />
        <img th:if="${track.coverUrl == null or #strings.isEmpty(track.coverUrl)}" th:src="@{/img/placeholder_cover.svg}" alt="Placeholder" />
    </div>
    <div class="player-text">
        <div class="player-title" th:text="${track.title}">Titolo</div>
        <div class="player-artist" th:text="${track.artist}">Artista</div>
        <div class="player-album" th:if="${track.albumLine != null}" th:text="${track.albumLine}">Album · Anno · Genere</div>
        <!-- Audio element visibile con controlli (pill) -->
        <audio id="player-audio" controls preload="metadata" th:src="${track.audioUrl}" aria-label="Player traccia"></audio>
    </div>
</div>
<script>
    // Back button logic: prefer redirect to specific playlist if params present
    (function(){
        const backBtn = document.getElementById('backToPlaylistBtn');
        if(!backBtn) return;
        // Estrae parametri dalla query string (playlistId e gr)
        const params = new URLSearchParams(window.location.search);
        const pid = params.get('playlistId') || params.get('playlist_id') || params.get('pid');
        const gr = params.get('gr');
        backBtn.addEventListener('click', () => {
            if(pid){
                let target = 'Playlist?playlistId=' + encodeURIComponent(pid);
                if(gr !== null && gr !== undefined && gr !== '') target += '&gr=' + encodeURIComponent(gr);
                window.location.href = target;
            } else {
                // Fallback: history.back()
                history.back();
            }
        });
    })();

    // Blurred album cover background
    (function(){
        const coverImg = document.querySelector('.player-cover img');
        if(!coverImg) return;
        const imgSrc = coverImg.src;
        if(!imgSrc) return;

        // Create layer
        let layer = document.getElementById('playerCoverBg');
        if(!layer){
            layer = document.createElement('div');
            layer.id = 'playerCoverBg';
            layer.className = 'player-bg';
            document.body.appendChild(layer);
        }
        layer.style.backgroundImage = `url('${imgSrc}')`;
        document.body.classList.add('has-player-bg');
    })();

    // Remove any tooltip on player box
    (function(){
        const playerBox = document.querySelector('.player-track-info');
        if(playerBox) playerBox.removeAttribute('title');
    })();
</script>
</body>
</html>
