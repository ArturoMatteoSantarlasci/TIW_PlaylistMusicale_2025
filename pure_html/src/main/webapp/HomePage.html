<!DOCTYPE html>
<html lang="it" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Home page</title>
    <link rel="stylesheet" href="css/app.css?v=20251002-1" th:href="@{/css/app.css(v=${#dates.createNow().getTime()})}" />
    <link rel="icon" sizes="32x32" type="image/png" href="img/icon.png" th:href="@{/img/icon.png}">
    <meta name="app-version" content="2025-10-02-1" />
</head>
<body class="page-home">
<div class="page-wrapper">
  <!-- Toolbar con titolo, ricerca e logout -->

  <header class="header">
    <div></div>
    <h1 class="header-title">Home</h1>
    <div style="text-align:right"><a class="btn secondary logout" href="Logout" th:href="@{/Logout}">Logout</a></div>
  </header>

  <div class="title-strip">
    <div class="title-strip-inner">Le mie Playlist</div>
  </div>

  <main class="main">
    <div class="actions-row">
      <button type="button" class="btn" onclick="openPlaylistModal()">Aggiungi playlist</button>
      <button type="button" class="btn" onclick="openTrackModal()">Carica brano</button>
      <a class="btn" href="All_Tracks.html" th:href="@{/All_Tracks}">Tutte le tracce</a>
    </div>

    <div class="playlists-wrapper">
      <div th:if="${!hasPlaylists}" style="padding:14px 0 6px;color:var(--am-muted);text-align:center;">Nessuna playlist ancora.</div>
      <div class="playlists-vertical" th:if="${hasPlaylists}">
        <a class="playlist-card-row" th:each="p : ${playlists}" th:href="@{/Playlist(playlistId=${p.id})}">
          <h3 class="pl-name" th:text="${p.title}">Nome Playlist</h3>
          <div style="font-size:.75rem;color:var(--am-muted);letter-spacing:.3px;">
            <span th:text="${p.tracksCount}">0</span> brani
            <span th:if="${p.creationDate != null}"> · <span th:text="${#temporals.format(p.creationDate,'dd/MM/yyyy')}">01/01/2025</span></span>
          </div>
        </a>
      </div>
    </div>
  </main>
</div>

<!-- Modal per aggiungere playlist -->
<div id="playlistModal" class="modal-overlay">
  <div class="modal">
    <div class="modal-header">
      <h2 class="modal-title">Nuova Playlist</h2>
      <button class="modal-close" type="button" onclick="closePlaylistModal()" aria-label="Chiudi">
        <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
          <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
        </svg>
      </button>
    </div>
    <div class="modal-content">
      <form id="playlistForm" action="CreatePlaylist" th:action="@{/CreatePlaylist}" method="post">
        <div class="form-group">
          <label class="form-label" for="playlistName">Nome della playlist</label>
          <div class="field">
            <input type="text" id="playlistName" name="playlistTitle" placeholder="Inserisci il nome..." required autocomplete="off" />
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Seleziona brani</label>
          <!-- Nuovo blocco compatto -->
          <div class="playlist-tracks-block" id="playlistTracksBlock">
            <div class="playlist-tracks-tools" th:if="${availableTracksCount > 0}">
              <div class="field" style="flex:1; height:42px;">
                <input type="search" id="trackFilter" placeholder="Filtra brani (titolo, artista, album)..." autocomplete="off" />
              </div>
              <div class="counts">
                <span id="selectedCount">0</span>/<span th:text="${availableTracksCount}">0</span> selezionati
              </div>
            </div>
            <ul class="playlist-tracks-list" id="playlistTracksList">
              <li class="playlist-tracks-empty" th:if="${availableTracksCount == 0}">Nessun brano disponibile</li>
              <li class="track-choice" th:each="t : ${availableTracks}">
                <input type="checkbox" th:id="'pltrk_' + ${t.id}" th:value="${t.id}" name="selectedTracks" />
                <label th:for="'pltrk_' + ${t.id}" class="track-choice-info">
                  <span class="track-choice-title" th:text="${t.title}">Titolo</span>
                  <span class="track-choice-meta">
                    <span th:text="${t.artist}">Artista</span>
                    <span> · </span>
                    <span th:text="${t.album_title}">Album</span>
                    <span th:if="${t.year != null}"> · <span th:text="${t.year}">2024</span></span>
                  </span>
                </label>
              </li>
            </ul>
            <div class="playlist-tracks-actions" th:if="${availableTracksCount > 0}">
              <button type="button" id="selectAllTracksBtn" title="Seleziona tutti i brani visibili">Seleziona tutti</button>
              <button type="button" id="clearTracksBtn" title="Deseleziona tutti i brani">Pulisci</button>
            </div>
          </div>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn ghost" onclick="closePlaylistModal()">Annulla</button>
          <button type="submit" class="btn">Crea Playlist</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal per caricare brano -->
<div id="trackModal" class="modal-overlay">
  <div class="modal">
    <div class="modal-header">
      <h2 class="modal-title">Carica Nuovo Brano</h2>
      <button class="modal-close" type="button" onclick="closeTrackModal()" aria-label="Chiudi">
        <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
          <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
        </svg>
      </button>
    </div>
    <div class="modal-content">
      <form id="trackForm" action="UploadTrack" th:action="@{/UploadTrack}" method="post" enctype="multipart/form-data">
        <div class="form-group">
          <label class="form-label" for="trackTitle">Titolo del brano</label>
          <div class="field">
            <input type="text" id="trackTitle" name="title" placeholder="Inserisci il titolo..." required autocomplete="off" />
          </div>
        </div>

        <div class="form-group">
          <label class="form-label" for="trackArtist">Artista/Gruppo</label>
          <div class="field">
            <input type="text" id="trackArtist" name="artist" placeholder="Nome dell'artista..." required autocomplete="off" />
          </div>
        </div>

        <div class="form-group">
          <label class="form-label" for="trackAlbum">Album</label>
          <div class="field">
            <input type="text" id="trackAlbum" name="album" placeholder="Nome dell'album..." required autocomplete="off" />
          </div>
        </div>

        <div class="form-group">
          <label class="form-label" for="trackYear">Anno di pubblicazione</label>
          <div class="field">
            <input type="number" id="trackYear" name="year" placeholder="2023" min="1900" max="2025" required autocomplete="off" />
          </div>
        </div>

        <div class="form-group">
          <label class="form-label" for="trackGenre">Genere</label>
          <div class="field">
            <input type="text" id="trackGenre" name="genre" placeholder="Rock, Pop, Jazz..." autocomplete="off" required />
          </div>
        </div>

        <div class="form-group">
          <label class="form-label" for="trackFile">File audio</label>
          <div class="field">
            <input type="file" id="trackFile" name="musicTrack" accept="audio/mp3,audio/wav,audio/ogg,audio/m4a" required />
          </div>
        </div>

        <div class="form-group">
          <label class="form-label" for="trackCover">Copertina</label>
          <div class="field">
            <input type="file" id="trackCover" name="image" accept="image/jpeg,image/png,image/gif,image/webp" required />
          </div>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn ghost" onclick="closeTrackModal()">Annulla</button>
          <button type="submit" class="btn">Carica Brano</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
// Gestione modali: apertura/chiusura, lock body e focus iniziale
(function modalManager(){
  'use strict';

  const MODALS = {
    playlist: { id: 'playlistModal', focusSelector: '#playlistModal input[type="text"]' },
    track: { id: 'trackModal', focusSelector: '#trackModal input[type="text"]' }
  };
  const overlays = new Map();
  const closeHooks = new Map();
  let activeKey = null;

  Object.entries(MODALS).forEach(([key, cfg]) => {
    const overlay = document.getElementById(cfg.id);
    if (!overlay) { return; }
    overlays.set(key, overlay);
    overlay.style.display = 'none';
    overlay.addEventListener('click', evt => {
      if (evt.target === overlay) {
        closeModal(key);
      }
    });
  });

  function anyModalOpen() {
    for (const overlay of overlays.values()) {
      if (overlay.classList.contains('active')) { return true; }
    }
    return false;
  }

  function lockBody() {
    document.body.dataset.modalOpen = '1';
    document.body.style.overflow = 'hidden';
  }

  function unlockBody() {
    delete document.body.dataset.modalOpen;
    document.body.style.overflow = '';
  }

  function focusField(selector) {
    if (!selector) { return; }
    const field = document.querySelector(selector);
    if (field) {
      setTimeout(() => field.focus(), 80);
    }
  }

  function openModal(key) {
    const cfg = MODALS[key];
    const overlay = overlays.get(key);
    if (!cfg || !overlay) { return; }
    activeKey = key;
    overlay.classList.add('active');
    overlay.style.display = 'flex';
    overlay.style.position = 'fixed';
    overlay.style.inset = '0';
    lockBody();
    focusField(cfg.focusSelector);
  }

  function closeModal(key) {
    const overlay = overlays.get(key);
    if (!overlay) { return; }
    const hook = closeHooks.get(key);
    if (hook) { hook(); }
    overlay.classList.remove('active');
    overlay.style.display = 'none';
    if (activeKey === key) {
      activeKey = null;
    }
    if (!anyModalOpen()) {
      unlockBody();
    }
  }

  window.openPlaylistModal = () => openModal('playlist');
  window.closePlaylistModal = () => closeModal('playlist');
  window.openTrackModal = () => openModal('track');
  window.closeTrackModal = () => closeModal('track');

  window.__registerModalCloseHook = (key, callback) => {
    if (MODALS[key]) {
      closeHooks.set(key, callback);
    }
  };

  window.addEventListener('load', () => {
    overlays.forEach(overlay => {
      if (!overlay.classList.contains('active')) {
        overlay.style.display = 'none';
      }
    });
  });

  document.addEventListener('keydown', evt => {
    if (evt.key === 'Escape' && activeKey) {
      closeModal(activeKey);
    }
  });
})();

// Funzionalità aggiuntive per il modal playlist: filtro, contatore, reset automatico
(function playlistModalEnhancements(){
  const list = document.getElementById('playlistTracksList');
  if(!list) return; // nessun elenco disponibile
  const filterInput = document.getElementById('trackFilter');
  const selectedCountEl = document.getElementById('selectedCount');
  const selectAllBtn = document.getElementById('selectAllTracksBtn');
  const clearBtn = document.getElementById('clearTracksBtn');

  function updateHighlight(chk){
    const li = chk.closest('li.track-choice');
    if(!li) return; li.classList.toggle('track-choice--selected', chk.checked);
  }
  function updateSelectedCount(){
    if(!selectedCountEl) return;
    const c = list.querySelectorAll('input[name="selectedTracks"]:checked').length;
    selectedCountEl.textContent = c;
  }
  function eachCheckbox(cb){ Array.prototype.forEach.call(list.querySelectorAll('input[name="selectedTracks"]'), cb); }

  // Inizializza highlight/contatore
  eachCheckbox(chk=>{ updateHighlight(chk); });
  updateSelectedCount();

  // Change listener
  list.addEventListener('change', e=>{
    if(e.target && e.target.matches('input[name="selectedTracks"]')){
      updateHighlight(e.target); updateSelectedCount();
    }
  });

  // Filtro
  if(filterInput){
    filterInput.addEventListener('input', () => {
      const term = filterInput.value.toLowerCase().trim();
      let visible = 0;
      list.querySelectorAll('li.track-choice').forEach(li => {
        const txt = (li.textContent || '').toLowerCase();
        const show = !term || txt.includes(term);
        li.style.display = show ? '' : 'none';
        if(show) visible++;
      });
      // Aggiorna bottone seleziona tutti stato disabled se 0 visibili
      if(selectAllBtn){ selectAllBtn.disabled = (visible === 0); }
    });
  }

  // Seleziona tutti (solo quelli visibili)
  if(selectAllBtn){
    selectAllBtn.addEventListener('click', () => {
      list.querySelectorAll('li.track-choice').forEach(li => {
        if(li.style.display === 'none') return; // skip filtrati
        const chk = li.querySelector('input[name="selectedTracks"]');
        if(chk && !chk.checked){ chk.checked = true; updateHighlight(chk); }
      });
      updateSelectedCount();
    });
  }

  // Pulisci tutti
  if(clearBtn){
    clearBtn.addEventListener('click', () => {
      eachCheckbox(chk => { if(chk.checked){ chk.checked=false; updateHighlight(chk);} });
      updateSelectedCount();
    });
  }

  function resetModalState(){
    if(filterInput){
      filterInput.value='';
      filterInput.dispatchEvent(new Event('input'));
    }
    eachCheckbox(chk => { if(chk.checked){ chk.checked=false; updateHighlight(chk);} });
    updateSelectedCount();
  }

  if (typeof window.__registerModalCloseHook === 'function') {
    window.__registerModalCloseHook('playlist', resetModalState);
  } else {
    const originalClose = window.closePlaylistModal;
    window.closePlaylistModal = function(){
      resetModalState();
      if (typeof originalClose === 'function') {
        originalClose();
      }
    };
  }
})();
</script>
</body>
</html>
